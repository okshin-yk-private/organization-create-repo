name: Terraform Test Matrix

on:
  pull_request:
    branches: [main]
    paths:
      - '**.tf'
      - '.github/workflows/terraform-test.yml'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: true
        type: choice
        options:
          - validate-only
          - plan-only
          - full-test
        default: plan-only
      branch_strategy:
        description: 'Branch strategy to test'
        required: false
        type: choice
        options:
          - gitflow
          - github-flow
          - both
        default: both

permissions:
  id-token: write
  contents: read
  pull-requests: write  # For commenting on PRs

jobs:
  terraform-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # ã‚¸ãƒ§ãƒ–å…¨ä½“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    strategy:
      fail-fast: false
      max-parallel: 1  # ä¸¦åˆ—å®Ÿè¡Œã‚’åˆ¶é™ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ç«¶åˆã‚’é˜²ã
      matrix:
        branch_strategy: 
          - ${{ github.event.inputs.branch_strategy == 'both' && 'gitflow' || github.event.inputs.branch_strategy == 'gitflow' && 'gitflow' || github.event.inputs.branch_strategy == 'github-flow' && 'github-flow' || 'gitflow' }}
          - ${{ github.event.inputs.branch_strategy == 'both' && 'github-flow' || github.event.inputs.branch_strategy == 'github-flow' && 'github-flow' || '' }}
        exclude:
          - branch_strategy: ''
    
    env:
      TF_VAR_test_mode: true
      TF_HTTP_MAX_RETRIES: "3"  # Terraform HTTPãƒªãƒˆãƒ©ã‚¤å›æ•°
      TF_HTTP_RETRY_WAIT_MIN: "1"  # æœ€å°å¾…æ©Ÿæ™‚é–“(ç§’)
      TF_HTTP_RETRY_WAIT_MAX: "30"  # æœ€å¤§å¾…æ©Ÿæ™‚é–“(ç§’)
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      timeout-minutes: 2  # AWSèªè¨¼ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.ROLE_ARN }}
        role-session-name: terraform-test-${{ matrix.branch_strategy }}-${{ github.run_number }}
        aws-region: ap-northeast-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.11.0"
        terraform_wrapper: false  # wrapperã‚’ç„¡åŠ¹åŒ–ã—ã¦é«˜é€ŸåŒ–

    - name: Generate GitHub App Token
      id: generate_token
      timeout-minutes: 2  # GitHub App Tokenç”Ÿæˆã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.GH_APP_APP_ID }}
        private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}
    
    - name: Set GitHub Token
      run: echo "GITHUB_TOKEN=${{ steps.generate_token.outputs.token }}" >> $GITHUB_ENV

    - name: Setup Test Environment
      timeout-minutes: 2  # ç’°å¢ƒè¨­å®šã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      run: |
        echo "ğŸ§ª ${{ matrix.branch_strategy }}æˆ¦ç•¥ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’è¨­å®šä¸­"
        
        # ãƒ†ã‚¹ãƒˆç”¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
        if [[ ! -f terraform.tfvars.example ]]; then
          echo "âŒ terraform.tfvars.exampleãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        cp terraform.tfvars.example terraform.tfvars
        sed -i "s/BRANCH_STRATEGY_PLACEHOLDER/${{ matrix.branch_strategy }}/g" terraform.tfvars
        
        echo "ğŸ“‹ ãƒ†ã‚¹ãƒˆè¨­å®š:"
        cat terraform.tfvars
        
        # ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
        if [[ "${{ inputs.test_mode }}" == "full-test" ]]; then
          echo "TF_LOG=DEBUG" >> $GITHUB_ENV
          echo "ğŸ› ãƒ‡ãƒãƒƒã‚°æœ‰åŠ¹ãªãƒ•ãƒ«ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰"
        fi

    - name: Terraform Init
      timeout-minutes: 5  # terraform initã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰è€ƒæ…®ï¼‰
      run: |
        echo "ğŸš€ Terraformã‚’åˆæœŸåŒ–ä¸­..."
        # HTTP_PROXYè¨­å®šã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é«˜é€ŸåŒ–
        terraform init -upgrade

    - name: Terraform Validate
      id: validate
      run: |
        echo "âœ… Terraformè¨­å®šã‚’æ¤œè¨¼ä¸­..."
        terraform validate -json > validate-results.json
        
        if terraform validate; then
          echo "âœ… ${{ matrix.branch_strategy }}æˆ¦ç•¥ã®æ¤œè¨¼ã«æˆåŠŸ"
        else
          echo "âŒ ${{ matrix.branch_strategy }}æˆ¦ç•¥ã®æ¤œè¨¼ã«å¤±æ•—"
          exit 1
        fi

    - name: Terraform Plan
      id: plan
      timeout-minutes: 8  # terraform planã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆAPIå‘¼ã³å‡ºã—è€ƒæ…®ï¼‰
      if: inputs.test_mode != 'validate-only'
      run: |
        echo "ğŸ“‹ ${{ matrix.branch_strategy }}æˆ¦ç•¥ã§Terraform Planã‚’å®Ÿè¡Œä¸­..."
        
        # ãƒ—ãƒ©ãƒ³ã®å®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ä»˜ãï¼‰
        for i in {1..3}; do
          if terraform plan -out=tfplan-${{ matrix.branch_strategy }} -detailed-exitcode > plan-output.log 2>&1; then
            PLAN_EXIT_CODE=$?
            break
          elif [[ $i -eq 3 ]]; then
            echo "âŒ 3å›ã®ãƒªãƒˆãƒ©ã‚¤å¾Œã‚‚å¤±æ•—"
            PLAN_EXIT_CODE=1
          else
            echo "âš ï¸ ãƒªãƒˆãƒ©ã‚¤ $i/3: 30ç§’å¾…æ©Ÿä¸­..."
            sleep 30
          fi
        done
        
        echo "plan_exit_code=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT
        
        if [[ $PLAN_EXIT_CODE -eq 1 ]]; then
          echo "âŒ ${{ matrix.branch_strategy }}æˆ¦ç•¥ã®ãƒ—ãƒ©ãƒ³ãŒå¤±æ•—"
          cat plan-output.log
          exit 1
        elif [[ $PLAN_EXIT_CODE -eq 2 ]]; then
          echo "ğŸ“ ${{ matrix.branch_strategy }}æˆ¦ç•¥ã§å¤‰æ›´ã‚’æ¤œå‡º"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… ${{ matrix.branch_strategy }}æˆ¦ç•¥ã§ã¯å¤‰æ›´ä¸è¦"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
        # ãƒ—ãƒ©ãƒ³çµæœã®ä¿å­˜
        terraform show -json tfplan-${{ matrix.branch_strategy }} > plan-${{ matrix.branch_strategy }}.json

    - name: Upload Plan Artifacts
      if: steps.plan.outputs.plan_exit_code != '1' && inputs.test_mode != 'validate-only'
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plans-${{ matrix.branch_strategy }}
        path: |
          tfplan-${{ matrix.branch_strategy }}
          plan-${{ matrix.branch_strategy }}.json
          plan-output.log

    - name: Display Plan Details
      if: inputs.test_mode == 'full-test' && steps.plan.outputs.has_changes == 'true'
      run: |
        echo "ğŸ” ãƒ—ãƒ©ãƒ³è©³ç´°ã‚’è¡¨ç¤ºä¸­..."
        echo "ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: tfplan-${{ matrix.branch_strategy }}ã®è©³ç´°ã‚’è¡¨ç¤º"
        echo "ãƒ—ãƒ©ãƒ³ã«ã¯ä»¥ä¸‹ã®å¤‰æ›´ãŒå«ã¾ã‚Œã¾ã™:"
        terraform show tfplan-${{ matrix.branch_strategy }}

    - name: Test Summary
      if: always()
      run: |
        echo "ğŸ“Š ${{ matrix.branch_strategy }}æˆ¦ç•¥ã®ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼:"
        echo "- æ¤œè¨¼: ${{ steps.validate.outcome }}"
        echo "- ãƒ—ãƒ©ãƒ³: ${{ steps.plan.outcome }}"
        echo "- å¤‰æ›´æœ‰ç„¡: ${{ steps.plan.outputs.has_changes || 'N/A' }}"

  test-results:
    needs: terraform-test
    runs-on: ubuntu-latest
    timeout-minutes: 5  # çµæœé›†ç´„ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    if: always()
    steps:
    - name: Download Plan Artifacts
      if: needs.terraform-test.result != 'failure'
      timeout-minutes: 3  # artifactãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      uses: actions/download-artifact@v4
      with:
        pattern: terraform-plans-*
        path: ./plans
        merge-multiple: true

    - name: Summarize Test Results
      run: |
        echo "ğŸ¯ ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼:"
        echo "- å…¨ä½“çš„ãªçŠ¶æ…‹: ${{ needs.terraform-test.result }}"
        
        if [[ -d "./plans" ]]; then
          echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ©ãƒ³:"
          ls -la ./plans/
        fi
        
        echo ""
        echo "âœ… ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã®ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"