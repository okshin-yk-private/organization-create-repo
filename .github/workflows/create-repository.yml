name: Create GitHub Repository

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: 'Repository name to create'
        required: true
        type: string
      branch_strategy:
        description: 'Branch strategy for the repository'
        required: true
        type: choice
        options:
          - gitflow
          - github-flow
        default: gitflow
      update_existing:
        description: 'æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã®æ›´æ–°ã‚’è¨±å¯ã™ã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„'
        required: false
        type: boolean
        default: false
      debug_mode:
        description: 'Enable debug output'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  create-repository:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.ROLE_ARN }}
        role-session-name: terraform-github-actions
        aws-region: ap-northeast-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.11.0"

    - name: Generate GitHub App Token
      id: generate_token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.GH_APP_APP_ID }} # Repository Secretã«GitHub Appã® App IDã‚’è¨­å®šã—ã¦ãŠãã¾ã™
        private-key: ${{ secrets.GH_APP_PRIVATE_KEY }} # Repository Secretã«GitHub Appã®Private keyã‚’è¨­å®šã—ã¦ãŠãã¾ã™
        owner: ${{ github.repository_owner }}
    
    - name: Set GitHub Token
      run: echo "GITHUB_TOKEN=${{ steps.generate_token.outputs.token }}" >> $GITHUB_ENV
    
    - name: Check Existing Repository
      id: check_repo
      run: |
        REPO_NAME="${{ inputs.repository_name }}"
        OWNER="${{ github.repository_owner }}"
        
        echo "## ğŸ” ãƒªãƒã‚¸ãƒˆãƒªç¢ºèª" >> $GITHUB_STEP_SUMMARY
        
        if gh repo view "${OWNER}/${REPO_NAME}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "### âš ï¸ æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã‚’æ¤œå‡º" >> $GITHUB_STEP_SUMMARY
          echo "ãƒªãƒã‚¸ãƒˆãƒª \`${REPO_NAME}\` ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã®æƒ…å ±ã‚’å–å¾—
          echo "**ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±:**" >> $GITHUB_STEP_SUMMARY
          gh repo view "${OWNER}/${REPO_NAME}" --json createdAt,description,isPrivate,defaultBranchRef \
            --jq '"- ä½œæˆæ—¥: \(.createdAt)\n- èª¬æ˜: \(.description // "ãªã—")\n- å¯è¦–æ€§: \(if .isPrivate then "Private" else "Public" end)\n- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒ: \(.defaultBranchRef.name)"' \
            >> $GITHUB_STEP_SUMMARY
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "### âœ… æ–°è¦ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™" >> $GITHUB_STEP_SUMMARY
          echo "ãƒªãƒã‚¸ãƒˆãƒª \`${REPO_NAME}\` ã‚’æ–°è¦ä½œæˆã—ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Validate Operation Mode
      run: |
        if [[ "${{ steps.check_repo.outputs.exists }}" == "true" ]]; then
          if [[ "${{ inputs.update_existing }}" != "true" ]]; then
            echo "## âŒ ã‚¨ãƒ©ãƒ¼: æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ãƒªãƒã‚¸ãƒˆãƒª \`${{ inputs.repository_name }}\` ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### å¯¾å‡¦æ–¹æ³•:" >> $GITHUB_STEP_SUMMARY
            echo "1. åˆ¥ã®ãƒªãƒã‚¸ãƒˆãƒªåã‚’ä½¿ç”¨ã™ã‚‹" >> $GITHUB_STEP_SUMMARY
            echo "2. æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã®æ›´æ–°ã‚’è¨±å¯ã™ã‚‹å ´åˆã¯ \`update_existing\` ã‚’ \`true\` ã«è¨­å®š" >> $GITHUB_STEP_SUMMARY
            echo "3. æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã‚’æ‰‹å‹•ã§å‰Šé™¤ã—ã¦ã‹ã‚‰å†å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
            
            echo "âŒ æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‡¦ç†ã‚’ä¸­æ­¢ã—ã¾ã™"
            echo "update_existing ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ true ã«è¨­å®šã™ã‚‹ã¨æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã§ãã¾ã™"
            exit 1
          else
            echo "## âš ï¸ æ›´æ–°ãƒ¢ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
            echo "æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒª \`${{ inputs.repository_name }}\` ã‚’æ›´æ–°ã—ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### æ³¨æ„äº‹é …:" >> $GITHUB_STEP_SUMMARY
            echo "- ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã®å¤‰æ›´ã«ã‚ˆã‚Šä¸€éƒ¨ãƒ–ãƒ©ãƒ³ãƒãŒå†ä½œæˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "- ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ãŒæ›´æ–°ã•ã‚Œã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "- ãƒªãƒã‚¸ãƒˆãƒªæœ¬ä½“ã®å‰Šé™¤ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
            
            echo "âš ï¸ æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™"
          fi
        else
          echo "âœ… æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™"
        fi
    
    - name: Setup Dynamic Configuration
      run: |
        # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
        if [[ "${{ inputs.debug_mode }}" == "true" ]]; then
          echo "TF_LOG=DEBUG" >> $GITHUB_ENV
          echo "ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ"
        fi
        
        # å‹•çš„ãªbackend.tfãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        cat > backend.tf << 'EOF'
        terraform {
          backend "s3" {
            bucket = "yk-private-terraform"
            key    = "github/repos/${{ inputs.repository_name }}/terraform.tfstate"
            region = "ap-northeast-1"
          }
        }
        EOF
        
        echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸbackend.tf:"
        cat backend.tf
        
        # å‹•çš„ãªterraform.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        cat > terraform.tfvars << EOF
        repository = {
          name = "${{ inputs.repository_name }}"
          description = "Repository created via GitHub Actions"
          branch_strategy = "${{ inputs.branch_strategy }}"
        }
        EOF
        
        echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸterraform.tfvars:"
        cat terraform.tfvars
    
    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: |
        set -o pipefail  # ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’æ­£ã—ãæ•æ‰
        
        echo "ğŸ“‹ Terraform Planã‚’å®Ÿè¡Œä¸­..."
        
        # terraform plan ã‚’å®Ÿè¡Œã—ã€exit codeã‚’ä¿å­˜
        set +e  # ä¸€æ™‚çš„ã«ã‚¨ãƒ©ãƒ¼æ™‚ã®å³åº§çµ‚äº†ã‚’ç„¡åŠ¹åŒ–
        terraform plan -out=tfplan -detailed-exitcode
        PLAN_EXIT_CODE=$?
        set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã®å³åº§çµ‚äº†ã‚’å†åº¦æœ‰åŠ¹åŒ–
        
        echo "ğŸ“Š Plan exit code: $PLAN_EXIT_CODE"
        
        if [[ $PLAN_EXIT_CODE -eq 1 ]]; then
          echo "âŒ Terraform planãŒå¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        elif [[ $PLAN_EXIT_CODE -eq 0 ]]; then
          echo "âœ… å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
        elif [[ $PLAN_EXIT_CODE -eq 2 ]]; then
          echo "ğŸ“ å¤‰æ›´ã‚’æ¤œå‡º - å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™"
          
          # å‰Šé™¤æ“ä½œã®æ¤œå‡º
          echo "ğŸ” å‰Šé™¤æ“ä½œã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          
          if [[ "${{ inputs.update_existing }}" != "true" ]]; then
            # æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰: å‰Šé™¤æ“ä½œã‚’å®Œå…¨ã«ç¦æ­¢
            if terraform show -json tfplan | jq '.resource_changes[] | select(.change.actions | contains(["delete"]))' | grep -q .; then
              echo "âŒ ã‚¨ãƒ©ãƒ¼: å‰Šé™¤æ“ä½œãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆæ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ï¼‰"
              echo "å‰Šé™¤ã•ã‚Œã‚‹äºˆå®šã®ãƒªã‚½ãƒ¼ã‚¹:"
              terraform show -json tfplan | jq -r '.resource_changes[] | select(.change.actions | contains(["delete"])) | "  - \(.type).\(.name) (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: \(.change.actions | join(",")))"'
              echo ""
              echo "æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã§ã¯å‰Šé™¤æ“ä½œã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
              exit 1
            fi
          else
            # æ›´æ–°ãƒ¢ãƒ¼ãƒ‰: ãƒªãƒã‚¸ãƒˆãƒªæœ¬ä½“ã®å‰Šé™¤ã®ã¿ç¦æ­¢
            if terraform show -json tfplan | jq '.resource_changes[] | select(.type == "github_repository" and .change.actions | contains(["delete"]))' | grep -q .; then
              echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒªãƒã‚¸ãƒˆãƒªæœ¬ä½“ã®å‰Šé™¤ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“"
              echo "æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ãƒªãƒã‚¸ãƒˆãƒªæœ¬ä½“ã®å‰Šé™¤ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚"
              exit 1
            fi
            
            # å‰Šé™¤ã•ã‚Œã‚‹äºˆå®šã®ãƒªã‚½ãƒ¼ã‚¹ã‚’è­¦å‘Šè¡¨ç¤º
            if terraform show -json tfplan | jq '.resource_changes[] | select(.change.actions | contains(["delete"]))' | grep -q .; then
              echo "âš ï¸ è­¦å‘Š: ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã¾ãŸã¯ç½®æ›ã•ã‚Œã¾ã™:"
              terraform show -json tfplan | jq -r '.resource_changes[] | select(.change.actions | contains(["delete"])) | "  - \(.type).\(.name) (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: \(.change.actions | join(",")))"'
            fi
          fi
          
          echo "âœ… å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯å®Œäº† - ãƒ—ãƒ©ãƒ³ã‚’é©ç”¨ã—ã¾ã™"
        else
          echo "âš ï¸ äºˆæœŸã—ãªã„exit code: $PLAN_EXIT_CODE"
          exit 1
        fi

    - name: Terraform Apply
      id: apply
      run: |
        echo "ğŸš€ Terraformã®å¤‰æ›´ã‚’é©ç”¨ä¸­..."
        if terraform apply -auto-approve tfplan; then
          echo "âœ… Terraform applyãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "âŒ Terraform applyãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
          terraform show
          exit 1
        fi

    - name: Output Results
      if: always()
      run: |
        echo "ğŸ“Š Terraformå‡ºåŠ›çµæœ:"
        
        if terraform output repository_url > /dev/null 2>&1; then
          echo "ğŸ”— ãƒªãƒã‚¸ãƒˆãƒªURL:"
          terraform output repository_url
          
          echo ""
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±:"
          terraform output repository_branches
          
          echo ""
          echo "ğŸ›¡ï¸ ä¿è­·ãƒ«ãƒ¼ãƒ«:"
          terraform output branch_protection_summary
          
          if terraform output created_branches > /dev/null 2>&1; then
            echo ""
            echo "ğŸ†• ä½œæˆã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒ:"
            terraform output created_branches
          fi
        else
          echo "âš ï¸ å‡ºåŠ›çµæœãŒã‚ã‚Šã¾ã›ã‚“ - ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi

    - name: Error Diagnosis
      if: failure()
      run: |
        echo "ğŸ” å¤±æ•—ã®åŸå› ã‚’è¨ºæ–­ä¸­..."
        
        echo "ğŸ“ TerraformçŠ¶æ…‹:"
        terraform show -no-color || echo "çŠ¶æ…‹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“"
        
        echo ""
        echo "ğŸ“‹ Terraformè¨­å®š:"
        echo "variables.tf:"
        head -20 variables.tf
        
        echo ""
        echo "terraform.tfvars:"
        cat terraform.tfvars
        
        echo ""
        echo "ğŸ”§ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
        terraform version
        
        echo ""
        echo "ğŸ“Š ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹:"
        terraform state list || echo "çŠ¶æ…‹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“"
