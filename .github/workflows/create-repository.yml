name: Create GitHub Repository

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: 'Repository name to create (or use default from variables)'
        required: false
        type: string
      branch_strategy:
        description: 'Branch strategy for the repository'
        required: false
        type: choice
        options:
          - default
          - gitflow
          - github-flow
        default: default
      debug_mode:
        description: 'Enable debug output'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  create-repository:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.ROLE_ARN }}
        role-session-name: terraform-github-actions
        aws-region: ap-northeast-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.11.0"

    - name: Generate GitHub App Token
      id: generate_token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.GH_APP_APP_ID }} # Repository Secretã«GitHub Appã® App IDã‚’è¨­å®šã—ã¦ãŠãã¾ã™
        private-key: ${{ secrets.GH_APP_PRIVATE_KEY }} # Repository Secretã«GitHub Appã®Private keyã‚’è¨­å®šã—ã¦ãŠãã¾ã™
        owner: ${{ github.repository_owner }}
    
    - name: Set GitHub Token
      run: echo "GITHUB_TOKEN=${{ steps.generate_token.outputs.token }}" >> $GITHUB_ENV
    
    - name: Setup Dynamic Configuration
      run: |
        # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
        if [[ "${{ inputs.debug_mode }}" == "true" ]]; then
          echo "TF_LOG=DEBUG" >> $GITHUB_ENV
          echo "ğŸ› Debug mode enabled"
        fi
        
        # å‹•çš„ãªterraform.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        cat > terraform.tfvars << EOF
        repositories = {
        EOF
        
        # ãƒªãƒã‚¸ãƒˆãƒªåã¨ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã®è¨­å®š
        if [[ -n "${{ inputs.repository_name }}" && "${{ inputs.branch_strategy }}" != "default" ]]; then
          # å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆ
          cat >> terraform.tfvars << EOF
          "${{ inputs.repository_name }}" = {
            description = "Repository created via GitHub Actions"
            branch_strategy = "${{ inputs.branch_strategy }}"
          }
        EOF
        else
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨
          cat >> terraform.tfvars << EOF
          "github-test-1" = {
            description = "Test repository 1"
            branch_strategy = "gitflow"
          }
          "github-test-2" = {
            description = "Test repository 2"  
            branch_strategy = "github-flow"
          }
        EOF
        fi
        
        cat >> terraform.tfvars << EOF
        }
        EOF
        
        echo "ğŸ“‹ Generated terraform.tfvars:"
        cat terraform.tfvars
    
    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: |
        echo "ğŸ“‹ Running Terraform Plan..."
        terraform plan -out=tfplan -detailed-exitcode
        PLAN_EXIT_CODE=$?
        
        if [[ $PLAN_EXIT_CODE -eq 1 ]]; then
          echo "âŒ Terraform plan failed"
          exit 1
        elif [[ $PLAN_EXIT_CODE -eq 2 ]]; then
          echo "ğŸ“ Changes detected - plan will be applied"
        else
          echo "âœ… No changes detected"
        fi

    - name: Terraform Apply
      id: apply
      run: |
        echo "ğŸš€ Applying Terraform changes..."
        if terraform apply -auto-approve tfplan; then
          echo "âœ… Terraform apply completed successfully"
        else
          echo "âŒ Terraform apply failed"
          echo "ğŸ“Š Checking current state..."
          terraform show
          exit 1
        fi

    - name: Output Results
      if: always()
      run: |
        echo "ğŸ“Š Terraform Outputs:"
        
        if terraform output repository_urls > /dev/null 2>&1; then
          echo "ğŸ”— Repository URLs:"
          terraform output repository_urls
          
          echo ""
          echo "ğŸŒ¿ Branch Information:"
          terraform output repository_branches
          
          echo ""
          echo "ğŸ›¡ï¸ Protection Rules:"
          terraform output branch_protection_summary
          
          if terraform output created_branches > /dev/null 2>&1; then
            echo ""
            echo "ğŸ†• Created Branches:"
            terraform output created_branches
          fi
        else
          echo "âš ï¸ No outputs available - check for errors above"
        fi

    - name: Error Diagnosis
      if: failure()
      run: |
        echo "ğŸ” Diagnosing failure..."
        
        echo "ğŸ“ Terraform State:"
        terraform show -no-color || echo "No state available"
        
        echo ""
        echo "ğŸ“‹ Terraform Configuration:"
        echo "variables.tf:"
        head -20 variables.tf
        
        echo ""
        echo "terraform.tfvars:"
        cat terraform.tfvars
        
        echo ""
        echo "ğŸ”§ Provider Versions:"
        terraform version
        
        echo ""
        echo "ğŸ“Š Resource Status:"
        terraform state list || echo "No state available"
    
    - name: Cleanup
      if: always()
      run: |
        rm -f github_app_key.pem
        rm -f tfplan
        rm -f terraform.tfvars