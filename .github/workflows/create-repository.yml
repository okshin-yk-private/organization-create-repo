name: Create GitHub Repository

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: 'Repository name to create'
        required: true
        type: string
      branch_strategy:
        description: 'Branch strategy for the repository'
        required: true
        type: choice
        options:
          - gitflow
          - github-flow
        default: gitflow
      debug_mode:
        description: 'Enable debug output'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  create-repository:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.ROLE_ARN }}
        role-session-name: terraform-github-actions
        aws-region: ap-northeast-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.11.0"

    - name: Generate GitHub App Token
      id: generate_token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.GH_APP_APP_ID }} # Repository Secretã«GitHub Appã® App IDã‚’è¨­å®šã—ã¦ãŠãã¾ã™
        private-key: ${{ secrets.GH_APP_PRIVATE_KEY }} # Repository Secretã«GitHub Appã®Private keyã‚’è¨­å®šã—ã¦ãŠãã¾ã™
        owner: ${{ github.repository_owner }}
    
    - name: Set GitHub Token
      run: echo "GITHUB_TOKEN=${{ steps.generate_token.outputs.token }}" >> $GITHUB_ENV
    
    - name: Setup Dynamic Configuration
      run: |
        # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
        if [[ "${{ inputs.debug_mode }}" == "true" ]]; then
          echo "TF_LOG=DEBUG" >> $GITHUB_ENV
          echo "ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ"
        fi
        
        # å‹•çš„ãªterraform.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        cat > terraform.tfvars << EOF
        repository = {
          name = "${{ inputs.repository_name }}"
          description = "Repository created via GitHub Actions"
          branch_strategy = "${{ inputs.branch_strategy }}"
        }
        EOF
        
        echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸterraform.tfvars:"
        cat terraform.tfvars
    
    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: |
        echo "ğŸ“‹ Terraform Planã‚’å®Ÿè¡Œä¸­..."
        terraform plan -out=tfplan -detailed-exitcode
        PLAN_EXIT_CODE=$?
        
        if [[ $PLAN_EXIT_CODE -eq 1 ]]; then
          echo "âŒ Terraform planãŒå¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        elif [[ $PLAN_EXIT_CODE -eq 2 ]]; then
          echo "ğŸ“ å¤‰æ›´ã‚’æ¤œå‡º - ãƒ—ãƒ©ãƒ³ã‚’é©ç”¨ã—ã¾ã™"
        else
          echo "âœ… å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
        fi

    - name: Terraform Apply
      id: apply
      run: |
        echo "ğŸš€ Terraformã®å¤‰æ›´ã‚’é©ç”¨ä¸­..."
        if terraform apply -auto-approve tfplan; then
          echo "âœ… Terraform applyãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "âŒ Terraform applyãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
          terraform show
          exit 1
        fi

    - name: Output Results
      if: always()
      run: |
        echo "ğŸ“Š Terraformå‡ºåŠ›çµæœ:"
        
        if terraform output repository_urls > /dev/null 2>&1; then
          echo "ğŸ”— ãƒªãƒã‚¸ãƒˆãƒªURL:"
          terraform output repository_url
          
          echo ""
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±:"
          terraform output repository_branches
          
          echo ""
          echo "ğŸ›¡ï¸ ä¿è­·ãƒ«ãƒ¼ãƒ«:"
          terraform output branch_protection_summary
          
          if terraform output created_branches > /dev/null 2>&1; then
            echo ""
            echo "ğŸ†• ä½œæˆã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒ:"
            terraform output created_branches
          fi
        else
          echo "âš ï¸ å‡ºåŠ›çµæœãŒã‚ã‚Šã¾ã›ã‚“ - ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi

    - name: Error Diagnosis
      if: failure()
      run: |
        echo "ğŸ” å¤±æ•—ã®åŸå› ã‚’è¨ºæ–­ä¸­..."
        
        echo "ğŸ“ TerraformçŠ¶æ…‹:"
        terraform show -no-color || echo "çŠ¶æ…‹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“"
        
        echo ""
        echo "ğŸ“‹ Terraformè¨­å®š:"
        echo "variables.tf:"
        head -20 variables.tf
        
        echo ""
        echo "terraform.tfvars:"
        cat terraform.tfvars
        
        echo ""
        echo "ğŸ”§ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
        terraform version
        
        echo ""
        echo "ğŸ“Š ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹:"
        terraform state list || echo "çŠ¶æ…‹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“"