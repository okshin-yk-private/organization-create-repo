name: Create GitHub Repository

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: 'Repository name to create'
        required: true
        type: string
      branch_strategy:
        description: 'Branch strategy for the repository'
        required: true
        type: choice
        options:
          - gitflow
          - github-flow
        default: gitflow
      update_existing:
        description: 'æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã®æ›´æ–°ã‚’è¨±å¯ã™ã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„'
        required: false
        type: boolean
        default: false
      debug_mode:
        description: 'Enable debug output'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  create-repository:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.ROLE_ARN }}
        role-session-name: terraform-github-actions
        aws-region: ap-northeast-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.11.0"

    - name: Generate GitHub App Token
      id: generate_token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.GH_APP_APP_ID }} # Repository Secretã«GitHub Appã® App IDã‚’è¨­å®šã—ã¦ãŠãã¾ã™
        private-key: ${{ secrets.GH_APP_PRIVATE_KEY }} # Repository Secretã«GitHub Appã®Private keyã‚’è¨­å®šã—ã¦ãŠãã¾ã™
        owner: ${{ github.repository_owner }}
    
    - name: Set GitHub Token
      run: echo "GITHUB_TOKEN=${{ steps.generate_token.outputs.token }}" >> $GITHUB_ENV
    
    - name: Check Existing Repository
      id: check_repo
      run: |
        REPO_NAME="${{ inputs.repository_name }}"
        OWNER="${{ github.repository_owner }}"
        
        echo "## ğŸ” ãƒªãƒã‚¸ãƒˆãƒªç¢ºèª" >> $GITHUB_STEP_SUMMARY
        
        if gh repo view "${OWNER}/${REPO_NAME}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "### âš ï¸ æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã‚’æ¤œå‡º" >> $GITHUB_STEP_SUMMARY
          echo "ãƒªãƒã‚¸ãƒˆãƒª \`${REPO_NAME}\` ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã®æƒ…å ±ã‚’å–å¾—
          echo "**ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±:**" >> $GITHUB_STEP_SUMMARY
          gh repo view "${OWNER}/${REPO_NAME}" --json createdAt,description,isPrivate,defaultBranchRef \
            --jq '"- ä½œæˆæ—¥: \(.createdAt)\n- èª¬æ˜: \(.description // "ãªã—")\n- å¯è¦–æ€§: \(if .isPrivate then "Private" else "Public" end)\n- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒ: \(.defaultBranchRef.name)"' \
            >> $GITHUB_STEP_SUMMARY
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "### âœ… æ–°è¦ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™" >> $GITHUB_STEP_SUMMARY
          echo "ãƒªãƒã‚¸ãƒˆãƒª \`${REPO_NAME}\` ã‚’æ–°è¦ä½œæˆã—ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Validate Operation Mode
      run: |
        if [[ "${{ steps.check_repo.outputs.exists }}" == "true" ]]; then
          if [[ "${{ inputs.update_existing }}" != "true" ]]; then
            echo "## âŒ ã‚¨ãƒ©ãƒ¼: æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ãƒªãƒã‚¸ãƒˆãƒª \`${{ inputs.repository_name }}\` ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### å¯¾å‡¦æ–¹æ³•:" >> $GITHUB_STEP_SUMMARY
            echo "1. åˆ¥ã®ãƒªãƒã‚¸ãƒˆãƒªåã‚’ä½¿ç”¨ã™ã‚‹" >> $GITHUB_STEP_SUMMARY
            echo "2. æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã®æ›´æ–°ã‚’è¨±å¯ã™ã‚‹å ´åˆã¯ \`update_existing\` ã‚’ \`true\` ã«è¨­å®š" >> $GITHUB_STEP_SUMMARY
            echo "3. æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã‚’æ‰‹å‹•ã§å‰Šé™¤ã—ã¦ã‹ã‚‰å†å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
            
            # ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆå¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã§å‚ç…§ï¼‰
            echo "EXISTING_REPOSITORY_ERROR" > /tmp/workflow_error
            echo "Repository '${{ inputs.repository_name }}' already exists and update_existing is false" >> /tmp/workflow_error
            
            echo "âŒ æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‡¦ç†ã‚’ä¸­æ­¢ã—ã¾ã™"
            echo "update_existing ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ true ã«è¨­å®šã™ã‚‹ã¨æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã§ãã¾ã™"
            exit 1
          else
            echo "## âš ï¸ æ›´æ–°ãƒ¢ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
            echo "æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒª \`${{ inputs.repository_name }}\` ã‚’æ›´æ–°ã—ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### æ³¨æ„äº‹é …:" >> $GITHUB_STEP_SUMMARY
            echo "- ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã®å¤‰æ›´ã«ã‚ˆã‚Šä¸€éƒ¨ãƒ–ãƒ©ãƒ³ãƒãŒå†ä½œæˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "- ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ãŒæ›´æ–°ã•ã‚Œã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "- ãƒªãƒã‚¸ãƒˆãƒªæœ¬ä½“ã®å‰Šé™¤ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
            
            echo "âš ï¸ æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™"
          fi
        else
          echo "âœ… æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™"
        fi
    
    - name: Setup Dynamic Configuration
      run: |
        # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
        if [[ "${{ inputs.debug_mode }}" == "true" ]]; then
          echo "TF_LOG=DEBUG" >> $GITHUB_ENV
          echo "ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ"
        fi
        
        # å‹•çš„ãªbackend.tfãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        cat > terraform/backend.tf << 'EOF'
        terraform {
          backend "s3" {
            bucket = "yk-private-terraform"
            key    = "github/repos/${{ inputs.repository_name }}/terraform.tfstate"
            region = "ap-northeast-1"
          }
        }
        EOF
        
        echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸbackend.tf:"
        cat terraform/backend.tf
        
        # å‹•çš„ãªterraform.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        cat > terraform/terraform.tfvars << EOF
        repository = {
          name = "${{ inputs.repository_name }}"
          description = "Repository created via GitHub Actions"
          branch_strategy = "${{ inputs.branch_strategy }}"
        }
        EOF
        
        echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸterraform.tfvars:"
        cat terraform/terraform.tfvars
    
    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Plan
      working-directory: terraform
      run: terraform plan -out=tfplan -detailed-exitcode

    - name: Terraform Apply
      id: apply
      working-directory: terraform
      run: |
        echo "ğŸš€ Terraformã®å¤‰æ›´ã‚’é©ç”¨ä¸­..."
        if terraform apply -auto-approve tfplan; then
          echo "âœ… Terraform applyãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "âŒ Terraform applyãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
          terraform show
          exit 1
        fi

    - name: Output Results
      if: always()
      run: |
        # ã‚¨ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [[ -f "/tmp/workflow_error" ]]; then
          echo "ğŸ“Š å®Ÿè¡Œçµæœ:"
          echo "âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã—ã¾ã—ãŸ"
          echo ""
          
          ERROR_TYPE=$(head -n 1 /tmp/workflow_error)
          if [[ "$ERROR_TYPE" == "EXISTING_REPOSITORY_ERROR" ]]; then
            echo "## ã‚¨ãƒ©ãƒ¼è©³ç´°"
            echo "æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒª \`${{ inputs.repository_name }}\` ãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‡¦ç†ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚"
            echo ""
            echo "## å¯¾å‡¦æ–¹æ³•"
            echo "1. åˆ¥ã®ãƒªãƒã‚¸ãƒˆãƒªåã‚’ä½¿ç”¨ã™ã‚‹"
            echo "2. \`update_existing\` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ \`true\` ã«è¨­å®šã—ã¦æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ"
            echo "3. æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã‚’æ‰‹å‹•ã§å‰Šé™¤ã—ã¦ã‹ã‚‰å†å®Ÿè¡Œ"
          fi
        else
          echo "ğŸ“Š Terraformå‡ºåŠ›çµæœ:"
          
          cd terraform
          if terraform output repository_url > /dev/null 2>&1; then
            echo "ğŸ”— ãƒªãƒã‚¸ãƒˆãƒªURL:"
            terraform output repository_url
            
            echo ""
            echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±:"
            terraform output repository_branches
            
            echo ""
            echo "ğŸ›¡ï¸ ä¿è­·ãƒ«ãƒ¼ãƒ«:"
            terraform output branch_protection_summary
            
            if terraform output created_branches > /dev/null 2>&1; then
              echo ""
              echo "ğŸ†• ä½œæˆã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒ:"
              terraform output created_branches
            fi
          else
            echo "âš ï¸ å‡ºåŠ›çµæœãŒã‚ã‚Šã¾ã›ã‚“ - ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          fi
        fi

    - name: Error Diagnosis
      if: failure()
      run: |
        echo "ğŸ” å¤±æ•—ã®åŸå› ã‚’è¨ºæ–­ä¸­..."
        
        # ã‚¨ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [[ -f "/tmp/workflow_error" ]]; then
          echo "ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ¬ãƒ™ãƒ«ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:"
          ERROR_TYPE=$(head -n 1 /tmp/workflow_error)
          ERROR_DETAIL=$(tail -n +2 /tmp/workflow_error)
          
          if [[ "$ERROR_TYPE" == "EXISTING_REPOSITORY_ERROR" ]]; then
            echo "âš ï¸ ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã®ç«¶åˆ"
            echo "ğŸ“ è©³ç´°: $ERROR_DETAIL"
            echo ""
            echo "## è§£æ±ºæ–¹æ³•:"
            echo "ã“ã®ã‚¨ãƒ©ãƒ¼ã¯Terraformã®å•é¡Œã§ã¯ãªãã€ãƒªãƒã‚¸ãƒˆãƒªã®é‡è¤‡ã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚"
            echo "1. ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªåã§å†å®Ÿè¡Œ"
            echo "2. update_existing=true ã§æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨"
            echo "3. æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã‚’å‰Šé™¤å¾Œã«å†å®Ÿè¡Œ"
          fi
        else
          echo "ğŸ“ Terraformé–¢é€£ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:"
          
          cd terraform
          echo "ğŸ“ TerraformçŠ¶æ…‹:"
          terraform show -no-color || echo "çŠ¶æ…‹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“"
          
          echo ""
          echo "ğŸ“‹ Terraformè¨­å®š:"
          if [[ -f "variables.tf" ]]; then
            echo "variables.tf:"
            head -20 variables.tf
          fi
          
          echo ""
          if [[ -f "terraform.tfvars" ]]; then
            echo "terraform.tfvars:"
            cat terraform.tfvars
          fi
          
          echo ""
          echo "ğŸ”§ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
          terraform version
          
          echo ""
          echo "ğŸ“Š ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹:"
          terraform state list || echo "çŠ¶æ…‹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“"
        fi
