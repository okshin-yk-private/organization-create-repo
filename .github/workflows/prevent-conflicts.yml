name: Prevent Merge Conflicts

on:
  pull_request:
    types: [opened, synchronize]
  schedule:
    - cron: '0 8 * * *'  # æ¯æ—¥æœ8æ™‚ã«ãƒã‚§ãƒƒã‚¯

jobs:
  conflict-prevention:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for potential conflicts
      run: |
        echo "ğŸ” æ½œåœ¨çš„ãªã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # mainã¨ã®å·®åˆ†ã‚’ãƒã‚§ãƒƒã‚¯
        if git merge-base --is-ancestor origin/main HEAD; then
          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒã¯æœ€æ–°ã®mainã‹ã‚‰ä½œæˆã•ã‚Œã¦ã„ã¾ã™"
        else
          echo "âš ï¸ ãƒ–ãƒ©ãƒ³ãƒãŒmainã‹ã‚‰é…ã‚Œã¦ã„ã¾ã™"
          echo "Files that may conflict:"
          git diff --name-only origin/main...HEAD
          
          # è‡ªå‹•ãƒªãƒ™ãƒ¼ã‚¹ææ¡ˆ
          echo "::warning::ã“ã®ãƒ–ãƒ©ãƒ³ãƒã¯mainã¨åŒæœŸãŒå¿…è¦ã§ã™ã€‚git rebase origin/main ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
        fi

    - name: Format check
      run: |
        echo "ğŸ“ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # Terraformãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        if command -v terraform >/dev/null 2>&1; then
          if ! terraform fmt -check=true -diff=true; then
            echo "::warning::Terraformãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒä¸æ­£ã§ã™ã€‚terraform fmt ã§ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
          fi
        fi

    - name: Report Status
      run: |
        echo "ğŸ“Š ãƒ–ãƒ©ãƒ³ãƒçŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆ:"
        echo "- ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.base_ref }}"  
        echo "- ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.head_ref }}"
        echo "- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)"